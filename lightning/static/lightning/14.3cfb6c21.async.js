(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[14],{PsOX:function(e,t,a){"use strict";a.r(t);var n,r,i,c=a("fWQN"),l=a("mtLc"),o=a("yKVA"),s=a("879j"),u=a("q1tI"),d=a.n(u),p=a("Ty5D"),m=a("LvDl"),f=a("/MKj"),y=a("Hx5s"),v=(a("52nx"),a("7bDm")),b=(a("eE3J"),a("GSZB")),h=(a("eNCU"),a("pjJH")),g=(a("SePM"),a("PMX6")),E=a("0Owb"),x=(a("lNFX"),a("VE2L")),_=(a("4X2C"),a("xvon")),j=a("9og8"),k=a("k1fw"),O=a("tS8v"),w=(a("yavW"),a("WuMn")),S=(a("vmZS"),a("NjVP")),C=(a("5RCp"),a("a82I")),M=(a("Ahcs"),a("k0dM")),F=a("WmNS"),N=a.n(F),q=a("RLxJ"),V=a("TSYQ"),A=a.n(V),T=a("E6Dt"),D=a("9Ndd"),W=a("NVqa"),P=a("psPf"),K=a("Nmjv"),L=a("jfUH"),J=a("tJVT"),R=a("4b23"),U=a.n(R),B=a("hjOt"),I={xs:{maxWidth:575},sm:{minWidth:576,maxWidth:767},md:{minWidth:768,maxWidth:991},lg:{minWidth:992,maxWidth:1199},xl:{minWidth:1200,maxWidth:1599},xxl:{minWidth:1600}},X=[{key:"before_create",title:"\u521b\u5efa\u6570\u636e\u524d"},{key:"after_create",title:"\u521b\u5efa\u6570\u636e\u540e"},{key:"before_update",title:"\u66f4\u65b0\u6570\u636e\u524d"},{key:"after_update",title:"\u66f4\u65b0\u6570\u636e\u540e"},{key:"before_delete",title:"\u5220\u9664\u6570\u636e\u524d"},{key:"after_delete",title:"\u5220\u9664\u6570\u636e\u540e"}],$=[{name:"name",label:"\u540d\u79f0",type:"string",component:"input",required:!0},{name:"event",label:"\u89e6\u53d1\u7c7b\u578b",type:"string",component:"select",choices:X,defaultValue:"after_create"},{name:"description",label:"\u63cf\u8ff0",type:"string",component:"textArea"},{name:"opened",label:"\u542f\u7528",type:"boolean",component:"switch",defaultValue:!1}],z=function(e){return[{name:"appModel".concat(e),label:"\u6a21\u578b",type:"array",component:"modelSelect"},{name:"filter".concat(e),label:"\u67e5\u8be2\u6761\u4ef6",type:"array",component:"querybuilder",schames:{}},{name:"setFields".concat(e),label:"\u4fdd\u5b58\u5b57\u6bb5",type:"string",component:"input",schames:{}}]},Q={create:{name:"\u521b\u5efa\u6570\u636e",action:z},update:{name:"\u66f4\u65b0\u6570\u636e",action:z},delete:{name:"\u5220\u9664\u6570\u636e",action:z},script:{name:"\u6267\u884c\u811a\u672c",action:[]}},H={before_create:{condition:"database",actions:["create","update","delete"]},after_create:{condition:"database",actions:["create","update","delete"]},before_update:{condition:"database",actions:["create","update","delete"]},after_update:{condition:"database",actions:["create","update","delete"]},before_delete:{condition:"database",actions:["create","update","delete"]},after_delete:{condition:"database",actions:["create","update","delete"]}},Y=function(e){var t={displayName:"default",name:"default__table",fields:[],titleField:"id"},a={displayName:"\u65e7\u5bf9\u8c61",name:"old",ref:"old",type:"ref"},n={displayName:"\u65b0\u5bf9\u8c61",name:"new",ref:"new",type:"ref"};return["before_update","after_update"].includes(e)&&t.fields.push(a,n),["before_create","after_create"].includes(e)&&t.fields.push(n),["before_delete","after_delete"].includes(e)&&t.fields.push(a),t},Z=function(e){var t={};return Object.keys(e).forEach((function(a){var n=e[a].value,r=n.name,i=n.type,c=n.value;"constant"===i&&(t[r]=JSON.stringify(c)),"system"===i&&(t[r]="".concat(Array.isArray(c)?c.join("."):c))})),t},G=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];function t(e){return e.map((function(e){var a=e.operator,n=e.value,r=e.field,i=e.type,c=e.children,l={operator:a};if(r&&i){l.field=r;var o={constant:JSON.stringify(n),system:"".concat(Array.isArray(n)?n.join("."):n)};l.expression=o[i]}else c&&(l.children=t(c));return l}))}return t(e)},ee=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];function t(e){return e.map((function(e){var a=e.operator,n=e.value,r=e.field,i=e.type,c=e.children,l={operator:a};if(r&&i){l.field="$".concat("{",r,"}");var o={constant:n,system:"$".concat("{",Array.isArray(n)?n.join("."):n,"}")};l.expression=o[i]}return c&&(l.children=t(c)),l}))}return t(e)},te=function(e){function t(e){return e.map((function(e){var a={operator:e.operator};return e.field&&(a.field=e.field.toString().replace(/[${}#]/g,""),a.type="constant",a.value=Object.keys(e).includes("expression")?e.expression:e.value,a.value.toString().search(/[$]/)>-1&&(a.type="system"),"system"===a.type&&(a.value=a.value.split("."),a.value=a.value.toString().replace(/[${}#]/g,""))),e.children&&(a.children=t(e.children)),a}))}var a=t(e);return a},ae=function(e,t){return Object.keys(e).map((function(a){var n=e[a].type;if(["create","update","delete"].includes(n)){var r=Object(J["a"])(t["actionModel".concat(a)],2),i=r[0],c=r[1],l={action:n,app:i,model:c};return["update","delete"].includes(n)&&(l.filters=G(t["actionFilter".concat(a)])),["update","create"].includes(n)&&(l.fields=Z(t["actionSetField".concat(a)])),l}if("script"===n){var o={action:n};return o.script=t["script".concat(a)],o}return null}))},ne=3,re=function e(t,a){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(n>ne)return[];var r=[];return t[a].fields.forEach((function(a){var i=Object(k["a"])({},a);i.value="".concat(a.name),i.label="".concat(a.name,"(").concat(a.displayName,")"),i.isLeaf=!0,i.type=a.type,(Object(L["D"])(a)||"mref"===a.type||"bref"===a.type)&&(i.isLeaf=!1,i.ref=a.ref,i.children=e(t,a.ref,n+1)),r.push(i)})),r},ie=function(e){var t=e.event,a={};if("database"===H[t].condition){var n=Object(J["a"])(e.qfModel,2),r=n[0],i=n[1],c=e.qfFilter;a.app=r,a.model=i,a.filters=ee(c)}return a},ce=function(e,t){var a=e.event,n={};if("database"===H[a].condition){var r=e.condition,i=r.app,c=r.model,l=r.filters,o=[i,c],s=te(l);t({qfModel:o},(function(){return setTimeout((function(){t({qfFilter:s})}),2e3)})),n.qfModel=o,n.qfFilter=s}return n},le=function(e){function t(e){return e.map((function(e){var a=e.operator,n=e.expression,r=e.field,i=e.children,c={operator:a};if(r){c.field=r;try{var l=JSON.parse(n);c.value=l,c.type="constant"}catch(o){c.value=n.split("."),c.type="system"}}return i&&(c.children=t(i)),c}))}return t(e)},oe=function(e,t){var a=t.schemas,n=t.app,r=t.model,i={};return Object.keys(e).forEach((function(t){var c={name:t};try{var l=JSON.parse(e[t]);c.value=l,c.type="constant"}catch(s){c.value=e[t].split("."),c.type="system"}var o={id:U()(),pid:-1,value:c};o.fieldNames=Object(B["b"])(a,"".concat(n,"__").concat(r)),i[o.id]=o})),i},se=function(e,t,a){var n={};return e.forEach((function(e,r){console.log("action: ",e);var i=e.action,c=e.app,l=e.model;if(["create","update","delete"].includes(i)){if(n["actionModel".concat(Object.keys(t)[r])]=[c,l],["update","delete"].includes(i)){var o=e.filters;n["actionFilter".concat(Object.keys(t)[r])]=le(o)}if(["update","create"].includes(i)){var s=e.fields;n["actionSetField".concat(Object.keys(t)[r])]=oe(s,{app:c,model:l,schemas:a})}}if("script"===i){var u=e.script;n["script".concat(Object.keys(t)[r])]=u}})),n},ue=a("bs5R"),de=a.n(ue),pe=a("mmaM");function me(){return fe.apply(this,arguments)}function fe(){return fe=Object(j["a"])(N.a.mark((function e(){var t,a,n,r=arguments;return N.a.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t=r.length>0&&void 0!==r[0]?r[0]:{},a=r.length>1?r[1]:void 0,n="save_trigger",(0===a||a)&&(n="update_trigger"),e.abrupt("return",Object(pe["request"])("/basebone/trigger_core__trigger/func/",{method:"POST",data:{func_name:n,params:{id:a,config:t}}}));case 5:case"end":return e.stop()}}),e)}))),fe.apply(this,arguments)}function ye(e){return ve.apply(this,arguments)}function ve(){return ve=Object(j["a"])(N.a.mark((function e(t){return N.a.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.abrupt("return",Object(pe["request"])("/basebone/trigger_core__trigger/func/",{method:"POST",data:{func_name:"show_trigger",params:{slug:t}}}));case 1:case"end":return e.stop()}}),e)}))),ve.apply(this,arguments)}var be,he,ge=M["a"].TabPane,Ee=C["a"].Step,xe=S["a"].Item,_e=w["a"].Option,je=D["b"].TextArea,ke=D["b"].Switch,Oe=[{key:"0",title:"\u914d\u7f6e\u89e6\u53d1\u5668"},{key:"1",title:"\u8bbe\u7f6e\u6761\u4ef6"},{key:"2",title:"\u8bbe\u7f6e\u52a8\u4f5c"}],we=0,Se=(n=Object(f["c"])(),r=Object(L["d"])((function(){return{appModels:Object(L["jb"])()}})),n(i=r(i=function(e){Object(o["a"])(a,e);var t=Object(s["a"])(a);function a(){var e;Object(c["a"])(this,a);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=t.call.apply(t,[this].concat(r)),e.state={current:0,actionKeys:{}},e.onAddAction=function(t){var a=e.state.actionKeys,n=Object(k["a"])({},a);n[we]={key:we,type:t},e.setState({actionKeys:n},(function(){e.handleCancel(),we+=1}))},e.onDelAction=function(t){var a=e.state.actionKeys,n=Object(k["a"])({},a);delete n[t],e.setState({actionKeys:n})},e.TabsOnChange=function(t){var a=e.state.current;return parseInt(t,10)>a?e.next():e.prev()},e.showModal=function(){e.setState({visible:!0})},e.handleCancel=function(){e.setState({visible:!1})},e.next=Object(j["a"])(N.a.mark((function t(){var a,n,r;return N.a.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return a=e.props.form.validateFields,t.next=3,a();case 3:n=e.state.current,r=n+1,e.setState({current:r});case 6:case"end":return t.stop()}}),t)}))),e.prev=function(){var t=e.state.current,a=t-1;e.setState({current:a})},e.getSch=function(){var t=e.props,a=t.schemas,n=t.form.getFieldValue,r=Object(O["a"])(e),i=r.qfModel,c=n("event");return Object(k["a"])(Object(k["a"])({},a),{},{old:{displayName:"old",name:"old__table",fields:a[i].fields,titleField:"id"},new:{displayName:"new",name:"new__table",fields:a[i].fields,titleField:"id"},default:Y(c)})},e.handleSubmit=Object(j["a"])(N.a.mark((function t(){var a,n,r,i,c,l,o,s,u,d,p,m,f,y,v;return N.a.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return a=e.props,n=a.form,r=n.getFieldsValue,i=n.validateFields,c=a.isUpdate,t.next=3,i();case 3:if(l=e.state.actionKeys,o=r(),s=o.name,u=o.event,d=o.description,p=o.opened,m=ae(l,o),f=ie(o),y={disable:!p,name:s,event:u,description:d,triggeraction:m,condition:f},!c){t.next=15;break}return v=e.props.id,t.next=13,me(y,parseInt(v,10));case 13:return q["a"].push("/content/trigger_core__trigger"),t.abrupt("return");case 15:return t.next=17,me(y);case 17:q["a"].push("/content/trigger_core__trigger");case 18:case"end":return t.stop()}}),t)}))),e}return Object(l["a"])(a,[{key:"componentDidMount",value:function(){var e=this.props.isUpdate;e&&this.setValues()}},{key:"setValues",value:function(){var e=Object(j["a"])(N.a.mark((function e(){var t,a,n,r,i,c,l,o,s,u,d,p,m,f;return N.a.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t=this.props,a=t.dispatch,n=t.id,r=t.form.setFieldsValue,i=t.schemas,e.next=3,a({type:"content/detail",payload:{model:"trigger_core__trigger",id:n}});case 3:return c=e.sent,l=c.slug,e.next=7,ye(l);case 7:o=e.sent,s=o.name,u=o.event,d=o.description,p=o.disable,m=o.triggeraction,r({name:s,event:u,description:d,opened:!p},(function(){ce(o,r)})),f={},m.forEach((function(e){var t=e.action;f[we]={key:we,type:t},we+=1})),this.setState({actionKeys:f},(function(){var e=se(m,f,i);console.log("actionsData: ",e),r(e)}));case 13:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"qfModel",get:function(){var e=this.props.form.getFieldValue,t=e("qfModel")&&e("qfModel").length&&e("qfModel").join("__");if(t)return t}},{key:"renderField",value:function(e){var t,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=a.itemProps,r=void 0===n?{}:n,i=a.widgetProps,c=void 0===i?{}:i,l=this.props.form.getFieldDecorator,o=_["a"],s=e.name,u=e.label,p=e.component,f=e.defaultValue,y=e.choices,v=void 0===y?[]:y,b=e.type,h=e.required,g=void 0!==h&&h,j={input:_["a"],select:w["a"],textArea:je,switch:ke,modelSelect:x["a"],querybuilder:W["d"]},O=Object(k["a"])({},c);if(j[p]&&(o=j[p]),"select"===p&&(Object(m["isEmpty"])(v)||(t=v.map((function(e){return d.a.createElement(_e,{key:e.key},e.title)})))),"modelSelect"===p){var S=this.props.appModels;O.options=S,O.placeholder="\u8bf7\u9009\u62e9",O.displayRender=function(e){return e.join("__")}}return d.a.createElement(xe,Object(E["a"])({},r,{label:u,key:s}),l(s,{initialValue:f,rules:[{required:g},{type:b}]})(d.a.createElement(o,O,t&&t)))}},{key:"render",value:function(){var e=this,t=this.props,a=t.isUpdate,n=t.schemas,r=t.form,i=r.resetFields,c=r.getFieldDecorator,l=r.getFieldValue,o=t.appModels,s=this.state,u=s.current,p=s.visible,m=s.actionKeys,f=function(){return d.a.createElement(g["a"],null,d.a.createElement(C["a"],{current:u},Oe.map((function(e){return d.a.createElement(Ee,{title:e.title,key:e.key})}))))},y="".concat(u),_={};a||(_.renderTabBar=f,_.activeKey=y);var j=function(t){var a={span:{xs:24,sm:3,md:2,lg:2,xl:2,xxl:1}[t]},n={span:{xs:24,sm:10,md:8,lg:5,xl:4,xxl:4}[t]};return d.a.createElement(g["a"],{style:{marginTop:8}},d.a.createElement("div",{className:de.a.title},"\u89e6\u53d1\u5668\u914d\u7f6e"),$.map((function(r){var i={span:{xs:24,sm:21,md:18,lg:15,xl:12,xxl:10}[t]};return"description"===r.name?e.renderField(r,{itemProps:{labelCol:a,wrapperCol:i}}):e.renderField(r,{itemProps:{labelCol:a,wrapperCol:n}})})))},k=d.a.createElement(x["a"],{options:o,placeholder:"\u8bf7\u9009\u62e9",displayRender:function(e){return e.join("__")}}),O=Object.keys(n)[0],w=O&&O.split("__")||[],F=function(t){var a={span:{xs:24,sm:3,md:2,lg:2,xl:2,xxl:1}[t]},n={span:{xs:24,sm:10,md:8,lg:5,xl:4,xxl:4}[t]},r=[],i=[],l=e.qfModel;if(l){var o=e.getSch();r=Object(K["k"])(o,"default"),i=re(o,"default")}return d.a.createElement(g["a"],{style:{marginTop:8}},d.a.createElement("div",{className:de.a.title},"\u6761\u4ef6\u8bbe\u7f6e"),d.a.createElement(xe,{labelCol:a,wrapperCol:n,label:"\u6a21\u578b"},c("qfModel",{initialValue:[]})(k)),d.a.createElement("div",null,d.a.createElement("div",{style:{paddingBottom:2}},d.a.createElement("span",{style:{fontSize:26}},"\u6ee1\u8db3\u6761\u4ef6")),d.a.createElement(xe,null,c("qfFilter",{initialValue:[]})(d.a.createElement(W["d"],{key:"qfFilter",columns:r,hideVariable:!0,systemData:i})))))},N=function(t,a,n){return d.a.createElement(g["a"],{style:{marginTop:8},key:"action".concat(a)},d.a.createElement("div",{className:"".concat(de.a.title," ").concat(de.a["space-between"])},d.a.createElement("div",null,n),d.a.createElement(h["a"],{onClick:function(){return e.onDelAction(a)}},"\u5220\u9664")),d.a.createElement(xe,{labelCol:24,wrapperCol:24,label:"\u811a\u672c"},c("script".concat(a))(d.a.createElement(P["a"],{firstLineNumber:3}))))},q=function(t,r,i,o){var s={span:{xs:24,sm:3,md:2,lg:2,xl:2,xxl:1}[t]},u={span:{xs:24,sm:10,md:8,lg:5,xl:4,xxl:4}[t]},p=l("actionModel".concat(r))&&l("actionModel".concat(r)).length&&l("actionModel".concat(r)).join("__"),m=[],f=e.qfModel;if(f){var y=e.getSch();m=re(y,"default"),m.push({label:"user",value:"user",isLeaf:!0,type:"ref"})}return d.a.createElement(g["a"],{style:{marginTop:8},key:"action".concat(r)},d.a.createElement("div",{className:"".concat(de.a.title," ").concat(de.a["space-between"])},d.a.createElement("div",null,i),d.a.createElement(h["a"],{onClick:function(){return e.onDelAction(r)}},"\u5220\u9664")),d.a.createElement(xe,{labelCol:s,wrapperCol:u,label:"\u6a21\u578b"},c("actionModel".concat(r),{initialValue:w})(k)),"create"!==o&&d.a.createElement("div",null,d.a.createElement("div",{style:{paddingBottom:2}},d.a.createElement("span",{style:{fontSize:26}},"\u67e5\u8be2\u6761\u4ef6")),d.a.createElement(xe,null,c("actionFilter".concat(r),{initialValue:[]})(d.a.createElement(W["d"],{columns:Object(K["k"])(n,p)||[],hideVariable:!0,systemData:m})))),"delete"!==o&&d.a.createElement(xe,null,c("actionSetField".concat(r),{initialValue:[]})(d.a.createElement(W["e"],{schemas:n,model:p,hideVariable:!0,systemData:m,isNew:!a,isNested:!1}))))},V=function(e){var t=l("event"),a={database:F};return d.a.createElement("div",null,a[H[t].condition](e))},D=function(t){var a={create:q,update:q,delete:q,script:N};return d.a.createElement("div",null,Object.keys(m).map((function(e){return a[m[e].type](t,e,Q[m[e].type].name,m[e].type)})),d.a.createElement(g["a"],{style:{marginTop:8,fontSize:20,textAlign:"center"},onClick:e.showModal},"\u6dfb\u52a0\u52a8\u4f5c ",d.a.createElement(b["a"],{style:{fontSize:20},type:"plus"})))},L={0:j,1:V,2:D},J=d.a.createElement("div",null,u>0&&!a&&d.a.createElement(h["a"],{style:{marginLeft:8},onClick:function(){return e.prev()}},"\u4e0a\u4e00\u6b65"),u<Oe.length-1&&!a&&d.a.createElement(h["a"],{style:{marginLeft:8},type:"primary",onClick:function(){return e.next()}},"\u4e0b\u4e00\u6b65"),(a||u===Oe.length-1)&&d.a.createElement(h["a"],{style:{marginLeft:8,marginRight:8},onClick:i},"\u53d6\u6d88"),(a||u===Oe.length-1)&&d.a.createElement(h["a"],{type:"primary",onClick:this.handleSubmit},"\u63d0\u4ea4"));return d.a.createElement("div",null,d.a.createElement(S["a"],null,d.a.createElement(v["a"],{title:"\u52a8\u4f5c\u7c7b\u578b",visible:p,footer:null,onCancel:this.handleCancel},d.a.createElement("div",null,Object.keys(Q).map((function(t){return d.a.createElement(h["a"],{block:!0,key:t,onClick:function(){return e.onAddAction(t)},style:{marginBottom:10}},Q[t].name)})))),d.a.createElement(T["ContainerQuery"],{query:I},(function(t){return d.a.createElement("div",null,!!A()(t)&&d.a.createElement("div",null),d.a.createElement(M["a"],Object(E["a"])({},_,{onChange:e.TabsOnChange,tabBarStyle:{backgroundColor:"white"},className:de.a["ant-tabs-bar"]}),Oe.map((function(e){return d.a.createElement(ge,{forceRender:!0,tab:e.title,key:e.key},L[e.key](A()(t)||"sm"),d.a.createElement(g["a"],{style:{marginTop:8}},J))}))))}))))}}]),a}(u["Component"]))||i)||i),Ce=S["a"].create({})(Se),Me=Ce,Fe=(be=Object(f["c"])((function(e){var t=e.content.schemas;return{schemas:t}})),Object(p["n"])(he=be(he=function(e){Object(o["a"])(a,e);var t=Object(s["a"])(a);function a(){return Object(c["a"])(this,a),t.apply(this,arguments)}return Object(l["a"])(a,[{key:"isUpdate",get:function(){var e=this.props.match.params.id;return!(0!==e&&!e)}},{key:"render",value:function(){var e=this.props.schemas,t=this.props.match.params.id;return Object(m["isEmpty"])(e)?null:d.a.createElement(Me,{isUpdate:this.isUpdate,schemas:e,id:t})}}]),a}(u["PureComponent"]))||he)||he);t["default"]=function(){return d.a.createElement(y["a"],null,d.a.createElement(Fe,null))}},bs5R:function(e,t,a){e.exports={title:"title___23rYW","space-between":"space-between___1QXu6","ant3-tabs-bar":"ant3-tabs-bar___1oxKo"}}}]);